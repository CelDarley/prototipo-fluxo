<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Produção</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="../css/thalamus.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuedraggable@2.24.3/dist/vuedraggable.umd.min.js"></script>
  <style>
    .container {
      width: 1900px !important;
      max-width: none !important;
    }
    .kanban-container {
      margin: 0;
      padding: 0;
      width: 100%;
      position: relative;
      display: block;
      overflow: hidden;
    }
    .kanban-board {
      min-height: 27vw;
      display: flex;
      flex-direction: row;
      gap: var(--margem);
      width: 100%;
      margin: 0;
      padding: 0;
      align-items: flex-start;
      position: relative;
      top: 0;
      left: 0;
    }
    .colunaKanban {
      border: 1px solid var(--cor-separador);
      border-radius: 12px;
      width: 210px;
      min-height: 400px;
      text-align: center;
      padding: var(--margem);
      background: var(--cor-bg);
      flex-shrink: 0;
      margin: 0;
      position: relative;
      top: 0;
      left: 0;
    }
    .colunaKanban:first-child {
      margin-top: 25px;
    }
    .colunaKanban h3 {
      margin-top: 0;
      color: var(--cor-fonte-forte);
    }
    .containerTarefa {
      margin-top: var(--margem);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .tarefa {
      border: 1px solid var(--cor-separador);
      border-radius: 12px;
      padding: var(--margem);
      margin: var(--margem) auto;
      text-align: left;
      box-sizing: border-box;
      background: var(--cor-bg);
      cursor: move;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .tarefa:hover {
      box-shadow: 0 2px 8px var(--cor-primaria-fraca);
      background: var(--cor-primaria-fraca);
      transform: translateY(-2px);
    }
    .tarefa .fonte-forte {
      font-size: 18px;
      display: block;
      overflow-wrap: break-word;
    }
    .rodapeTarefa {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-top: var(--margem);
    }
    .rodapeTarefa > div {
      flex: 1 1 0%;
      min-width: 150px;
    }
    .rodapeTarefa > span {
      flex: 1 1 0%;
      min-width: 100px;
      text-align: left;
    }
    @media (max-width: 1200px) {
      .kanban-board { 
        flex-wrap: nowrap;
      }
      .colunaKanban { 
        width: 300px;
      }
    }
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      display: flex; justify-content: center; align-items: flex-start;
      z-index: 9999;
      overflow-y: auto;
      padding: 20px 0;
    }
    .modal-content {
      background: var(--cor-bg);
      padding: var(--margem);
      border-radius: 12px;
      width: 90%;
      max-width: 1200px;
      position: relative;
      box-shadow: 0 2px 16px var(--cor-cinza);
      animation: modalIn 0.2s;
      margin: 20px auto;
      max-height: none;
      overflow-y: visible;
    }
    .modal-close {
      position: absolute;
      top: 10px; right: 10px;
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--cor-fonte);
    }
    @keyframes modalIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-control {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 0.5rem;
    }
    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }
    .btn-secondary {
      background-color: #f44336;
      color: white;
    }
    .abas {
      margin: 0;
      padding: 0;
      display: flex;
      gap: 5px;
      margin-bottom: var(--margem);
      position: relative;
    }
    .abas a {
      border: 1px solid var(--cor-separador);
      padding: 10px;
      text-decoration: none;
      border-radius: 12px;
      display: inline-block;
      color: var(--cor-fonte);
      margin: 0;
    }
    .abas .ativo {
      background-color: var(--cor-primaria-fraca);
      color: var(--cor-primaria-forte);
    }
  </style>
</head>
<body>
  <div id="producao">
    <section>
      <div class="titulo">
        <div class="margem container">
          <div class="m-icone esquerda">
            <a class="icone-voltar m-d" title="Voltar"></a>
          </div>
          <h2>Produção</h2>
        </div>
      </div>
      <div class="margem container">
        <div class="abas">
          <a class="ativo">Ordens de produção</a>
          <a>Kanban</a>
        </div>
        <div class="kanban-container">
          <div class="kanban-board">
            <div class="colunaKanban bloco" style="border-color: rgb(255, 145, 0);">
              <h3>OP OK</h3>
              <div class="containerTarefa">
                <draggable v-model="kanban['OP OK']" group="tarefas" @end="onEnd" :animation="150" ghost-class="ghost">
                  <div v-for="(tarefa, idx) in kanban['OP OK']" :key="'ok-'+idx" class="tarefa bloco" @click="abrirModalTratarOP(tarefa)">
                    <span class="fonte-forte" style="font-size: 18px; display: block; word-wrap: break-word;">{{ tarefa.titulo }}</span>
                    <div class="rodapeTarefa">
                      <div style="flex: 1; min-width: 150px;">
                        <span class="fonte-forte" style="display: block; word-wrap: break-word;">{{ tarefa.codigo }}</span>
                      </div>
                      <span style="flex: 1; min-width: 100px; text-align: left;">
                        <span>{{ tarefa.cliente }}</span>
                        <span>{{ tarefa.percentual }}</span>
                      </span>
                      <div style="flex: 1; min-width: 100px; text-align: left;">
                        <span class="fonte-forte">Prev. Concl:</span> {{ tarefa.previsao }}
                      </div>
                    </div>
                  </div>
                </draggable>
              </div>
            </div>
            <div class="colunaKanban bloco" style="border-color: rgb(0, 47, 255);">
              <h3>OP Com pendência</h3>
              <div class="containerTarefa">
                <draggable v-model="kanban['OP Com pendência']" group="tarefas" @end="onEnd" :animation="150" ghost-class="ghost">
                  <div v-for="(tarefa, idx) in kanban['OP Com pendência']" :key="'pend-'+idx" class="tarefa bloco" @click="abrirModalTratarOP(tarefa)">
                    <span class="fonte-forte" style="font-size: 18px; display: block; word-wrap: break-word;">{{ tarefa.titulo }}</span>
                    <div class="rodapeTarefa">
                      <div style="flex: 1; min-width: 150px;">
                        <span class="fonte-forte" style="display: block; word-wrap: break-word;">{{ tarefa.codigo }}</span>
                      </div>
                      <span style="flex: 1; min-width: 100px; text-align: left;">
                        <span>{{ tarefa.cliente }}</span>
                        <span>{{ tarefa.percentual }}</span>
                      </span>
                      <div style="flex: 1; min-width: 100px; text-align: left;">
                        <span class="fonte-forte">Prev. Concl:</span> {{ tarefa.previsao }}
                      </div>
                    </div>
                  </div>
                </draggable>
              </div>
            </div>
            <div class="colunaKanban bloco" style="border-color: rgb(0, 192, 0);">
              <h3>OP em tratamento</h3>
              <div class="containerTarefa"></div>
            </div>
            <div class="colunaKanban bloco" style="border-color: rgb(255, 165, 0);">
              <h3>Separação de material</h3>
              <div class="containerTarefa"></div>
            </div>
            <div class="colunaKanban bloco" style="border-color: rgb(255, 165, 0);">
              <h3>Produção/Montagem</h3>
              <div class="containerTarefa"></div>
            </div>
            <div class="colunaKanban bloco" style="border-color: rgb(255, 0, 0);">
              <h3>Expedição</h3>
              <div class="containerTarefa"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Modal Tratar OP -->
    <div v-if="showModal" class="modal-overlay" @click.self="fecharModal">
      <div class="modal-content">
        <button class="modal-close" @click="fecharModal">&times;</button>
        <h2>Tratar Ordem de Produção</h2>
        <div class="bloco">
          <div class="margem grid-3">
            <div>
              <label>Produto</label>
              <input type="text" v-model="opSelecionada.produto" readonly>
            </div>
            <div>
              <label>Quantidade a Produzir</label>
              <input type="number" v-model="opSelecionada.quantidade">
            </div>
            <div>
              <label>Previsão de Conclusão</label>
              <input type="date" v-model="opSelecionada.previsaoConclusao">
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;"></div>
          <table class="tabela">
            <tbody>
              <tr>
                <th scope="col" style="white-space: nowrap;">Produto</th>
                <th scope="col" style="white-space: nowrap;">Quantidade</th>
                <th scope="col" style="white-space: nowrap;">Estoque</th>
                <th scope="col" style="white-space: nowrap;">Comprar</th>
                <th scope="col" style="white-space: nowrap;">Produzir</th>
              </tr>
              <tr v-for="(material, index) in materiais" :key="index" style="cursor: pointer;">
                <td>{{ material.nome }}</td>
                <td><input type="text" size="7" v-model="material.quantidade"></td>
                <td>{{ material.estoque }}</td>
                <td>
                  <button class="v-btn v-btn--elevated v-btn--icon v-theme--light v-btn--density-default v-btn--size-default v-btn--variant-elevated acao-secundaria" @click="abrirModalComprar(material)">
                    <span class="v-btn__overlay"></span>
                    <span class="v-btn__underlay"></span>
                    <span data-no-activator="" class="v-btn__content">
                      <i aria-hidden="true" class="mdi-plus mdi v-icon notranslate v-theme--light v-icon--size-default"></i>
                      Comprar
                    </span>
                  </button>
                </td>
                <td>
                  <button class="v-btn v-btn--elevated v-btn--icon v-theme--light v-btn--density-default v-btn--size-default v-btn--variant-elevated acao-secundaria" @click="abrirModalProducao(material)">
                    <span class="v-btn__overlay"></span>
                    <span class="v-btn__underlay"></span>
                    <span data-no-activator="" class="v-btn__content">
                      <i aria-hidden="true" class="mdi-plus mdi v-icon notranslate v-theme--light v-icon--size-default"></i>
                      Produzir
                    </span>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="margem grid-3"></div>
        </div>
      </div>
    </div>

    <!-- Modal Comprar Material -->
    <div v-if="showModalComprar" class="modal-overlay" @click.self="fecharModalComprar">
      <div class="modal-content">
        <button class="modal-close" @click="fecharModalComprar">&times;</button>
        <div class="bloco margem">
          <h2>Solicitar Compra de Material</h2>
          <form @submit.prevent="confirmarCompra">
            <div class="grid-3">
              <div class="form-group">
                <label>Produto</label>
                <input type="text" v-model="materialSelecionado.nome" readonly="readonly" class="form-control">
              </div>
              <div class="form-group">
                <label>Quantidade</label>
                <input type="number" v-model="quantidadeCompra" min="1" class="form-control">
              </div>
              <div class="form-group">
                <label>Previsão de Entrega</label>
                <input type="date" v-model="previsaoEntrega" class="form-control">
              </div>
            </div>
            <div class="grid-2">
              <div class="form-group">
                <label>Sugestão de Fornecedor</label>
                <select v-model="fornecedorSelecionado" class="form-control">
                  <option value="">Selecione um fornecedor</option>
                  <option value="1">Fornecedor A</option>
                  <option value="2">Fornecedor B</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Observações</label>
              <textarea v-model="observacoesCompra" rows="3" class="form-control"></textarea>
            </div>
            <div class="margem">
              <button type="submit" class="btn btn-primary">Confirmar Pedido de Compra</button>
              <button type="button" class="btn btn-secondary" @click="fecharModalComprar">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Produção -->
    <div v-if="showModalProducao" class="modal-overlay" @click.self="fecharModalProducao">
      <div class="modal-content">
        <button class="modal-close" @click="fecharModalProducao">&times;</button>
        <div class="bloco margem">
          <h2>Criar Ordem de Produção</h2>
          <div class="bloco">
            <div class="margem grid-3">
              <div>
                <label>Produto</label>
                <input type="text" v-model="materialSelecionado.nome" readonly="readonly">
              </div>
              <div>
                <label>Previsão de Conclusão</label>
                <input type="date" v-model="previsaoConclusao">
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
              <button type="button" class="v-btn v-btn--elevated v-btn--icon v-theme--light v-btn--density-default v-btn--size-default v-btn--variant-elevated acao-secundaria" @click="adicionarDestino">
                <span class="v-btn__overlay"></span>
                <span class="v-btn__underlay"></span>
                <span data-no-activator="" class="v-btn__content">
                  <i aria-hidden="true" class="mdi-plus mdi v-icon notranslate v-theme--light v-icon--size-default"></i>
                </span>
              </button>
            </div>
            <table class="tabela">
              <tbody>
                <tr>
                  <th scope="col" style="white-space: nowrap;">Destino</th>
                  <th scope="col" style="white-space: nowrap;">Quantidade</th>
                  <th scope="col" style="white-space: nowrap;">Anexo</th>
                </tr>
                <tr v-for="(destino, index) in destinos" :key="index" style="cursor: pointer;">
                  <td>
                    <select v-model="destino.nome" class="form-control">
                      <option value="COFERMETA SA">COFERMETA SA</option>
                      <option value="USINA ALTO VERDE">USINA ALTO VERDE</option>
                      <option value="ESTOQUE">ESTOQUE</option>
                    </select>
                  </td>
                  <td><input type="text" size="7" v-model="destino.quantidade"></td>
                  <td><input type="text" v-model="destino.anexo"></td>
                </tr>
              </tbody>
            </table>
            <div class="margem grid-3">
              <div>
                <label>Quantidade a Produzir</label>
                <input type="number" v-model="quantidadeProducao">
              </div>
            </div>
          </div>
          <div class="bloco margem">
            <h3>Itens do Produto</h3>
            <br>
            <table class="tabela">
              <tbody>
                <tr>
                  <th scope="col" style="white-space: nowrap;">Item</th>
                  <th scope="col" style="white-space: nowrap;">Quantidade</th>
                </tr>
                <tr v-for="(item, index) in itensProduto" :key="index" style="cursor: pointer;">
                  <td>{{ item.nome }}</td>
                  <td><input type="text" size="7" v-model="item.quantidade"></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="bloco margem">
            <h3>Informações Adicionais</h3>
            <br>
            <div class="grid-2">
              <div>
                <label>Data de Início da Produção</label>
                <input type="date" v-model="dataInicioProducao">
              </div>
              <div>
                <label>Data de Conclusão da Produção</label>
                <input type="date" v-model="dataConclusaoProducao">
              </div>
            </div>
          </div>
          <div class="bloco margem">
            <h3>Observações</h3>
            <br>
            <div>
              <textarea v-model="observacoesProducao"></textarea>
            </div>
          </div>
          <div class="submit direita margem">
            <button class="btn btn-primary" @click="salvarProducao">Salvar</button>
            <button class="btn btn-secondary" @click="fecharModalProducao">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    new Vue({
      el: '#producao',
      data: {
        showModal: false,
        showModalComprar: false,
        showModalProducao: false,
        materialSelecionado: {
          nome: '',
          quantidade: 0,
          estoque: 0
        },
        quantidadeCompra: 1,
        previsaoEntrega: '',
        fornecedorSelecionado: '',
        observacoesCompra: '',
        opSelecionada: {
          produto: '',
          quantidade: 0,
          previsaoConclusao: '',
          observacoes: '',
          status: 'Em andamento'
        },
        materiais: [
          {
            nome: 'INJ010010 - FRONTAL M7 T113 T116',
            quantidade: 500,
            estoque: 400
          },
          {
            nome: 'FIX010033 - PAR PH AAT 2,9 X 6,5 PAN PRATA',
            quantidade: 2000,
            estoque: 1500
          },
          {
            nome: 'FIX010013 - ARRUELA 5/32 POL LISA PRATA',
            quantidade: 2000,
            estoque: 3000
          },
          {
            nome: 'ADS010007 - BORRACHA FE 20X10 ST',
            quantidade: 2000,
            estoque: 7000
          },
          {
            nome: 'PRE030003 - GABARITO DE COLAGEM CENTRAL MIKE',
            quantidade: 500,
            estoque: 100
          }
        ],
        kanban: {
          'OP OK': [
            {
              titulo: 'OP4450 - PA',
              codigo: '1500 - CST040003',
              cliente: 'Solinftec',
              percentual: '10%',
              previsao: '10/04/2025'
            },
            {
              titulo: 'OP4451 - PB',
              codigo: '1501 - CST040004',
              cliente: 'Solinftec',
              percentual: '20%',
              previsao: '12/04/2025'
            }
          ],
          'OP Com pendência': [
            {
              titulo: 'OP4452 - PC',
              codigo: '1502 - CST040005',
              cliente: 'Solinftec',
              percentual: '5%',
              previsao: '15/04/2025'
            },
            {
              titulo: 'OP4453 - PD',
              codigo: '1503 - CST040006',
              cliente: 'Solinftec',
              percentual: '30%',
              previsao: '18/04/2025'
            }
          ]
        },
        previsaoConclusao: '',
        quantidadeProducao: 0,
        destinos: [],
        itensProduto: [
          {
            nome: 'PMP010006 - CHAPA POLIESTIRENO PRETO COM FILME 1000 X 2000 X 3MM',
            quantidade: 0
          }
        ],
        dataInicioProducao: '',
        dataConclusaoProducao: '',
        observacoesProducao: ''
      },
      methods: {
        abrirModalTratarOP(tarefa) {
          this.opSelecionada = {
            produto: tarefa.codigo,
            quantidade: 1650,
            previsaoConclusao: tarefa.previsao,
            observacoes: '',
            status: 'Em andamento'
          };
          this.showModal = true;
        },
        fecharModal() {
          this.showModal = false;
          this.opSelecionada = {
            produto: '',
            quantidade: 0,
            previsaoConclusao: '',
            observacoes: '',
            status: 'Em andamento'
          };
        },
        abrirModalComprar(material) {
          this.materialSelecionado = { ...material };
          this.quantidadeCompra = material.quantidade;
          this.previsaoEntrega = new Date().toISOString().split('T')[0];
          this.fornecedorSelecionado = '';
          this.observacoesCompra = '';
          this.showModalComprar = true;
        },
        fecharModalComprar() {
          this.showModalComprar = false;
          this.materialSelecionado = {
            nome: '',
            quantidade: 0,
            estoque: 0
          };
          this.quantidadeCompra = 1;
          this.previsaoEntrega = '';
          this.fornecedorSelecionado = '';
          this.observacoesCompra = '';
        },
        confirmarCompra() {
          // Validar dados antes de confirmar
          if (!this.validarCompra()) {
            return;
          }

          const pedidoCompra = {
            material: this.materialSelecionado,
            quantidade: this.quantidadeCompra,
            previsaoEntrega: this.previsaoEntrega,
            fornecedor: this.fornecedorSelecionado,
            observacoes: this.observacoesCompra
          };

          console.log('Dados do pedido de compra:', pedidoCompra);
          alert('Pedido de compra registrado com sucesso!');
          this.fecharModalComprar();
        },
        validarCompra() {
          if (!this.materialSelecionado.nome) {
            alert('Selecione um material');
            return false;
          }

          if (this.quantidadeCompra <= 0) {
            alert('A quantidade deve ser maior que zero');
            return false;
          }

          if (!this.previsaoEntrega) {
            alert('Informe a previsão de entrega');
            return false;
          }

          if (!this.fornecedorSelecionado) {
            alert('Selecione um fornecedor');
            return false;
          }

          return true;
        },
        abrirModalProducao(material) {
          this.materialSelecionado = { ...material };
          this.quantidadeProducao = material.quantidade;
          this.previsaoConclusao = new Date().toISOString().split('T')[0];
          this.dataInicioProducao = new Date().toISOString().split('T')[0];
          this.dataConclusaoProducao = new Date().toISOString().split('T')[0];
          this.destinos = [
            { nome: 'COFERMETA SA', quantidade: '', anexo: '000545' },
            { nome: 'USINA ALTO VERDE', quantidade: '', anexo: '000545' },
            { nome: 'ESTOQUE', quantidade: '', anexo: '000545' }
          ];
          this.observacoesProducao = '';
          this.showModalProducao = true;
        },
        fecharModalProducao() {
          this.showModalProducao = false;
          this.materialSelecionado = {
            nome: '',
            quantidade: 0,
            estoque: 0
          };
          this.quantidadeProducao = 0;
          this.previsaoConclusao = '';
          this.destinos = [];
          this.dataInicioProducao = '';
          this.dataConclusaoProducao = '';
          this.observacoesProducao = '';
        },
        adicionarDestino() {
          this.destinos.push({
            nome: '',
            quantidade: '',
            anexo: '000545'
          });
        },
        salvarProducao() {
          // Validar dados antes de salvar
          if (!this.validarProducao()) {
            return;
          }

          const ordemProducao = {
            material: this.materialSelecionado,
            quantidade: this.quantidadeProducao,
            previsaoConclusao: this.previsaoConclusao,
            destinos: this.destinos,
            itensProduto: this.itensProduto,
            dataInicio: this.dataInicioProducao,
            dataConclusao: this.dataConclusaoProducao,
            observacoes: this.observacoesProducao
          };

          console.log('Dados da ordem de produção:', ordemProducao);
          alert('Ordem de produção criada com sucesso!');
          this.fecharModalProducao();
        },
        validarProducao() {
          if (!this.materialSelecionado.nome) {
            alert('Selecione um material');
            return false;
          }

          if (this.quantidadeProducao <= 0) {
            alert('A quantidade deve ser maior que zero');
            return false;
          }

          if (!this.previsaoConclusao) {
            alert('Informe a previsão de conclusão');
            return false;
          }

          if (this.destinos.length === 0) {
            alert('Adicione pelo menos um destino');
            return false;
          }

          return true;
        },
        onEnd(evt) {
          console.log('Card movido:', evt);
        }
      }
    });
  </script>
</body>
</html> 